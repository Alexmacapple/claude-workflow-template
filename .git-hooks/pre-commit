#!/bin/bash

# pre-commit hook
# VÃ©rifie la conformitÃ© des fichiers Markdown avant commit
# RÃ©fÃ©rence: .claude/rules/markdown-rules.md

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# VÃ©rifier si des fichiers .MD/.md sont staged
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|MD)$')

if [ -z "$STAGED_MD_FILES" ]; then
  # Aucun fichier Markdown staged, continuer le commit
  exit 0
fi

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Hook pre-commit : vÃ©rification Markdown${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

VIOLATIONS_FOUND=0

# Pattern d'emojis Ã  dÃ©tecter
EMOJI_PATTERN='[âœ…âŒâš ï¸â³ðŸŽ¯ðŸ“šðŸ”¥ðŸ’¡ðŸ†â­ðŸ”´ðŸŸ¡ðŸŸ¢ðŸš€ðŸ“âœ¨ðŸŽ‰ðŸ”§ðŸ“ŠðŸŽ¨ðŸ› ï¸ðŸ’»ðŸ”ðŸ“Œâš¡ðŸŒŸ]'

echo -e "${YELLOW}VÃ©rification des fichiers staged...${NC}"
echo ""

# VÃ©rifier chaque fichier staged
while IFS= read -r file; do
  if [ -f "$file" ]; then
    echo -e "  Analyse: ${file}"

    # 1. VÃ©rifier emojis interdits
    # Utiliser git show :0:file pour obtenir la version staged
    EMOJI_LINES=$(git show ":0:$file" 2>/dev/null | grep -n "$EMOJI_PATTERN" || true)

    if [ ! -z "$EMOJI_LINES" ]; then
      echo -e "    ${RED}âœ— VIOLATION${NC}: Emoji(s) interdit(s) dÃ©tectÃ©(s)"
      echo "$EMOJI_LINES" | head -3 | while IFS=: read -r line_num line_content; do
        echo -e "      Ligne $line_num: $(echo "$line_content" | cut -c1-60)..."
      done
      VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
      echo ""
    fi

    # 2. VÃ©rifier capitalisation anglaise des titres
    # Pattern: "## Mot Mot" avec plusieurs mots en majuscule
    # Exclure noms propres courants
    CAPS_LINES=$(git show ":0:$file" 2>/dev/null | \
      grep -n '^##\+ [A-Z][a-zÃ©Ã¨ÃªÃ«Ã Ã¢Ã¤Ã´Ã¶Ã¹Ã»Ã¼]* [A-Z]' | \
      grep -v "Claude Code\|GitHub\|GitLab\|Git\|PostgreSQL\|MongoDB\|Redis\|Docker\|React\|Vue\.js\|Node\.js\|Next\.js\|TypeScript\|JavaScript\|VS Code\|API REST\|HTTP\|JSON\|YAML\|HTML\|CSS\|SQL\|ADR\|PRD\|BRIEF\|STACK\|MVP\|CI/CD\|WCAG\|CRUD\|Hooks Git\|Python\|Java\|Express\|TailwindCSS\|Prisma\|PDF\|PNG\|JPEG\|SVG\|YOLO\|JWT\|Vite\|Vercel\|Railway\|Commander\.js\|Nullish Coalescing\|No Spec\|CLI\|Task()\|File System\|Lightning Talk\|Front Matter\|REST\|Zod\|Option [A-Z]\|CSRF\|Talk Standard\|Routes API\|Code Source\|Projet [A-Z]\|Applications Web\|Projets par\|Outils CLI\|Pattern AAA\|OWASP Top" || true)

    if [ ! -z "$CAPS_LINES" ]; then
      echo -e "    ${RED}âœ— VIOLATION${NC}: Capitalisation anglaise dÃ©tectÃ©e"
      echo "$CAPS_LINES" | head -3 | while IFS=: read -r line_num line_content; do
        echo -e "      Ligne $line_num: $line_content"
      done
      VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
      echo ""
    fi

    # Si aucune violation pour ce fichier
    if [ -z "$EMOJI_LINES" ] && [ -z "$CAPS_LINES" ]; then
      echo -e "    ${GREEN}âœ“${NC} Conforme"
      echo ""
    fi
  fi
done <<< "$STAGED_MD_FILES"

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

if [ "$VIOLATIONS_FOUND" -gt 0 ]; then
  echo -e "${RED}âœ— COMMIT BLOQUÃ‰${NC}"
  echo ""
  echo -e "${YELLOW}Des violations des rÃ¨gles Markdown ont Ã©tÃ© dÃ©tectÃ©es.${NC}"
  echo ""
  echo "Veuillez corriger les violations avant de committer :"
  echo "  1. Supprimer les emojis des fichiers .MD"
  echo "  2. Corriger la capitalisation des titres (style franÃ§ais)"
  echo "  3. Relancer le commit"
  echo ""
  echo "RÃ©fÃ©rence: .claude/rules/markdown-rules.md"
  echo ""
  echo "Pour vÃ©rifier tous les fichiers :"
  echo "  ./check-markdown-rules.sh"
  echo ""
  echo -e "${YELLOW}Pour bypasser ce hook (dÃ©conseillÃ©) :${NC}"
  echo "  git commit --no-verify"
  echo ""
  exit 1
else
  echo -e "${GREEN}âœ“ Tous les fichiers Markdown sont conformes${NC}"
  echo ""
  exit 0
fi
